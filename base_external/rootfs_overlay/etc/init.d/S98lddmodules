#!/bin/sh


MODDIR="/lib/modules/$(uname -r)/extra"

case "$1" in
  start)
    echo "S98lddmodules start"

    # Load LDD sample modules 
    [ -x /usr/bin/scull_load ]   && ( cd "$MODDIR" && /usr/bin/scull_load )   || true
    [ -x /usr/bin/module_load ]  && ( cd "$MODDIR" && /usr/bin/module_load faulty ) || true
    modprobe hello 2>/dev/null || true

    # ---- aesdchar:
    modprobe aesdchar 2>/dev/null || insmod "$MODDIR/aesdchar.ko" 2>/dev/null || true

    if [ ! -e /dev/aesdchar ]; then
      MAJOR=$(awk '$2=="aesdchar"{print $1}' /proc/devices)
      [ -n "$MAJOR" ] && mknod /dev/aesdchar c "$MAJOR" 0
    fi

    [ -e /dev/aesdchar ] && chmod 666 /dev/aesdchar

    echo "S98lddmodules done"
    ;;

  stop)
    echo "S98lddmodules stop"

    # Unload aesdchar first and clean node
    rmmod aesdchar 2>/dev/null || true
    [ -e /dev/aesdchar ] && rm -f /dev/aesdchar

    # Unload LDD sample modules 
    [ -x /usr/bin/module_unload ] && /usr/bin/module_unload faulty || true
    [ -x /usr/bin/scull_unload ]  && /usr/bin/scull_unload        || true
    rmmod hello 2>/dev/null || true

    echo "S98lddmodules done"
    ;;

  restart)
    "$0" stop
    "$0" start
    ;;

  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
    ;;
esac

exit 0

